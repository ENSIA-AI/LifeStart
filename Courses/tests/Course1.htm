<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>individual-course</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="css-files/individual-course.css">
</head>
<body>
  <nav class="navbar bg-light navbar-expand-lg fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Course 1</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Navigation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
          <li class="nav-item">
            <a class="nav-link active mx-lg-2" aria-current="page" href="#">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link mx-lg-2" href="#">About Program</a>
          </li>
            <li class="nav-item">
            <a class="nav-link mx-lg-2" href="welcoming-page.htm">Go Back</a>
          </li>
        </ul>
        
      </div>
    </div>
  </div>
</nav>
<main>
     <!-- LEFT -->
     <div class="left-side">
       <div id="player"></div>
        <h1>Description :</h1>
        <p class="course-description">
          In this course you will be introduced to one of the most commun terms and concepts in Islam religion , which is Aquidah , you'll know its meaning , its importance and the way you can apply it in your life with Allah.
        </p>
     </div>
        
  
      <!-- RIGHT: Subtitle Tracker -->
  <div class="tracker" id="tracker"></div>
   
  
   
    
</main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  <script>
    let player;
    let subtitlesDivs;
    let subtitles = []; //the parts will be tracked in an array
    const trackerDiv = document.getElementById("tracker");
    let watchedTime = parseFloat(localStorage.getItem("watchedTime")) || 0;
    let lastTime = 0;
    let trackingInterval = null;
         //once we embedded the api link //the function is called automatically


        const tag =document.createElement('script');
          tag.src= "https://www.youtube.com/iframe_api";
          document.body.appendChild(tag);

          //called automatically when the api is ready
         function onYouTubeIframeAPIReady(){
            player = new YT.Player('player' ,{
                height: '390',
                width: '640',
                videoId:'CQ6C4NXJaUc', //the video id //extracted from the link of the video
                playerVars :{playsinline: 1 ,controls: 1 , rel:0 },
                events:{
                    onReady: onPlayerReady,
                    onStateChange :onPlayerStateChange,
                },
            });
         }
     //the function to call when the video is ready to play
         function onPlayerReady(){
           const totalDuration = player.getDuration();
           const partDuration = totalDuration / 5;
            for (let i = 0; i < 5; i++) {
             subtitles.push({
             text: `Part ${i + 1}`,
             start: i * partDuration,
              end: (i + 1) * partDuration,
      });
    }

    //to display the tracker on the page 
    trackerDiv.innerHTML = "";
    subtitles.forEach((s) => {
      const div = document.createElement("div");
      div.classList.add("subtitle");
      div.textContent = s.text;
      trackerDiv.appendChild(div);
    });
    subtitlesDivs = document.querySelectorAll('.subtitle');
    console.log(`Video duration: ${totalDuration.toFixed(2)} seconds`);
     //restoring the watched time if  available
    if(watchedTime > 0 && watchedTime <player.getDuration()){
      player.seekTo(watchedTime , true);
    }
    console.log(`video duration : ${totalDuration.toFixed(2)} seconds`);
  }
  
  //tracking the states (pausing /playing / stopping)
   function onPlayerStateChange(event){
      if(event.data == YT.PlayerState.PLAYING){
        lastTime = player.getCurrentTime(); 
        trackingInterval = setInterval(()=>{
            const time = player.getCurrentTime();
            highlightSubtitle(time);
            updateWatchedTime(time);
        } , 500);
      }
      else if(
        event.data ==YT.PlayerState.PAUSED ||
        event.data == YT.PlayerState.ENDED
      ){
          clearInterval(trackingInterval);
      }
   }

   //to add styling effects to our tracker
            function highlightSubtitle(time){
                subtitles.forEach((s, i) =>{
                    if (time >= s.start && time < s.end){
                        subtitlesDivs[i].classList.add('active');

                    }
                    else{
                        subtitlesDivs[i].classList.remove('active');
                    }
                })
            }
      function updateWatchedTime(time){
        //this condition is necessary in case the user decided to rewatch any part , it would'nt effect on the real watched time
        if(time > lastTime){
          watchedTime += (time - lastTime);
        }
        lastTime = time;
      }
  window.addEventListener("beforeunload" , () =>{
      localStorage.setItem("watched time" , watchedTime.toFixed(2));
  })
   window.addEventListener("load" , () => {
      console.log(`the previous time is ${watchedTime.toFixed(2)}`);
   });

   //the unlocking function
   function ToUnlock(time){
    const total = player.getDuration();
    const percentage = (watchedTime / total) * 100;
    if(percentage >= 80){
       localStorage.setItem("courseUnlocked" , "true");
       console.log("unlocked next course");
    }
   }
 </script>
</body>
</html>