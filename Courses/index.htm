<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Course Cards â€” Lock / Unlock Demo</title>
<style>
  /* Layout */
  :root {
    --card-w: 280px;
    --card-h: 180px;
    --gap: 18px;
    --accent: #2b6cb0;
    --bg: #f7fafc;
    --card-bg: #ffffff;
    --radius: 12px;
  }
  body {
    font-family: Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    background: var(--bg);
    margin: 24px;
    color: #111827;
  }
  h1 { margin: 0 0 16px 0; font-size: 20px; }
  .grid {
    display: flex;
    gap: var(--gap);
    flex-wrap: wrap;
  }

  /* Card 3D flip container */
  .card {
    width: var(--card-w);
    height: var(--card-h);
    perspective: 1100px;
    position: relative;
    user-select: none;
  }
  .card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    transition: transform 0.7s cubic-bezier(.2,.9,.2,1);
    transform-style: preserve-3d;
    border-radius: var(--radius);
    box-shadow: 0 6px 16px rgba(16,24,40,0.08);
  }
  /* flipped state */
  .card.flipped .card-inner {
    transform: rotateY(180deg);
  }

  /* front/back faces */
  .card-face {
    position: absolute;
    inset: 0;
    backface-visibility: hidden;
    border-radius: var(--radius);
    overflow: hidden;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(180deg,#fff,#fbfdff);
    padding: 12px;
    box-sizing: border-box;
  }
  .card-back {
    transform: rotateY(180deg);
    background: linear-gradient(180deg,#f8fafc,#ffffff);
  }

  /* header inside card */
  .card-title {
    font-weight: 600;
    margin-bottom: 8px;
    text-align: center;
  }
  .card-sub {
    font-size: 13px;
    color: #475569;
    text-align: center;
  }

  /* lock overlay */
  .lock-overlay {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    background: linear-gradient(180deg, rgba(10,10,10,0.06), rgba(10,10,10,0.04));
    z-index: 40;
    pointer-events: none; /* allow clicks passthrough only when unlocked */
  }
  .lock-badge {
    background: rgba(255,255,255,0.9);
    border-radius: 999px;
    padding: 6px 10px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-weight: 600;
    color: #0f172a;
    box-shadow: 0 6px 18px rgba(2,6,23,0.08);
    pointer-events: auto;
  }

  /* locked state */
  .card.locked .lock-overlay { pointer-events: all; }
  .card.locked .card-inner { filter: grayscale(.02) contrast(.95); }

  /* click area */
  .card-click {
    position: absolute;
    inset: 0;
    z-index: 30;
    cursor: pointer;
    background: transparent;
  }
  .card.locked .card-click {
    cursor: not-allowed;
  }

  /* video inside first card */
  .video-box {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
  }
  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 8px;
  }

  /* small controls / progress */
  .progress {
    width: 100%;
    height: 8px;
    background: #e6eef9;
    border-radius: 999px;
    margin-top: 8px;
    overflow: hidden;
  }
  .progress > i {
    display: block;
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, var(--accent), #2c7be5);
    transition: width .25s linear;
  }

  /* flip hint */
  .hint {
    font-size: 12px;
    color: #475569;
    margin-top: 6px;
  }

  /* accessibility focus outline */
  .card-click:focus { outline: 3px solid rgba(59,130,246,.18); outline-offset: 3px; }

  /* small responsive */
  @media (max-width:640px){
    .grid { justify-content: center; }
  }
</style>
</head>
<body>

<h1>My Course Cards</h1>
<p style="margin:0 0 18px 0;color:#475569">
  First card contains the course video. Watching it fully unlocks the next course.
</p>

<div class="grid" id="cardsGrid" aria-live="polite">
  <!-- Card 0: Video + tracker (unlocked by default) -->
  <div class="card" data-index="0" id="card-0" role="group" aria-label="Course 1 (video)">
    <div class="card-inner">
      <div class="card-face card-front">
        <div class="card-title">Course 1 â€” Intro (Video)</div>
        <div class="card-sub">Watch the video fully to unlock Course 2</div>

        <div class="video-box" style="width:100%;height:100%;margin-top:8px;">
          <!-- Put your real video src here -->
          <video id="theVideo" controls preload="metadata" playsinline>
            <source src="https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4" type="video/mp4">
            Your browser does not support the video tag.
          </video>
          <div class="progress" aria-hidden="true"><i id="progBar"></i></div>
          <div style="display:flex;gap:8px;margin-top:8px;align-items:center;">
            <div style="font-size:13px;color:#334155">Watched: <strong id="watchedPct">0%</strong></div>
            <div style="margin-left:auto;font-size:13px;color:#64748b" id="videoState">Not complete</div>
          </div>
        </div>
      </div>

      <div class="card-face card-back" aria-hidden="true">
        <div class="card-title">Course 1 â€” Details</div>
        <div class="card-sub">Exercises and notes for Course 1.</div>
      </div>
    </div>

    <!-- lock overlay only visible for locked cards -->
    <div class="lock-overlay" aria-hidden="true" style="display:none;">
      <div class="lock-badge">ðŸ”’ Locked</div>
    </div>
    <!-- clickable area to flip the card (but disabled when locked) -->
    <button class="card-click" aria-pressed="false" title="Flip card"></button>
  </div>

  <!-- Card 1: locked initially -->
  <div class="card locked" data-index="1" id="card-1" role="group" aria-label="Course 2">
    <div class="card-inner">
      <div class="card-face card-front">
        <div class="card-title">Course 2 â€” Locked</div>
        <div class="card-sub">Locked. Finish previous video to unlock.</div>
      </div>

      <div class="card-face card-back" aria-hidden="true">
        <div class="card-title">Course 2 â€” Lesson</div>
        <div class="card-sub">Here is the lesson content once unlocked.</div>
      </div>
    </div>

    <div class="lock-overlay" aria-hidden="false">
      <div class="lock-badge">ðŸ”’ Locked</div>
    </div>
    <button class="card-click" aria-pressed="false" title="Flip card"></button>
  </div>

  <!-- Card 2: locked initially -->
  <div class="card locked" data-index="2" id="card-2" role="group" aria-label="Course 3">
    <div class="card-inner">
      <div class="card-face card-front">
        <div class="card-title">Course 3 â€” Locked</div>
        <div class="card-sub">Locked. Unlock by completing previous lessons.</div>
      </div>

      <div class="card-face card-back" aria-hidden="true">
        <div class="card-title">Course 3 â€” Lesson</div>
        <div class="card-sub">Course 3 content.</div>
      </div>
    </div>

    <div class="lock-overlay" aria-hidden="false">
      <div class="lock-badge">ðŸ”’ Locked</div>
    </div>
    <button class="card-click" aria-pressed="false" title="Flip card"></button>
  </div>
</div>

<script>
/*
  Behavior implemented:
  - Video played ranges are checked using video.played (TimeRanges).
  - Consider "fully watched" when total played ranges >= 98% of duration.
  - When first video's watched fully, unlock the immediately next card (index+1).
  - Lock state persisted in localStorage: key 'lockedCourses' stores array of unlocked indexes.
  - Card flip toggled by clicking the .card-click button when unlocked.
*/

(function(){
  const WATCH_THRESHOLD = 0.98; // fraction of duration considered as "watched"
  const STORAGE_KEY = 'course_unlocks_v1';

  const video = document.getElementById('theVideo');
  const progBar = document.getElementById('progBar');
  const watchedPct = document.getElementById('watchedPct');
  const videoState = document.getElementById('videoState');

  // Utility: read saved unlocked state from localStorage
  function readState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return {};
      return JSON.parse(raw) || {};
    } catch(e){ return {}; }
  }
  // write state
  function writeState(obj) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(obj)); } catch(e){}
  }

  // init UI from saved state
  function initFromState() {
    const st = readState();
    document.querySelectorAll('.card').forEach(card => {
      const idx = Number(card.dataset.index);
      if (idx === 0) {
        // first card should be unlocked always
        card.classList.remove('locked');
        hideLock(card);
      } else {
        const unlocked = !!st['unlocked_' + idx];
        if (unlocked) {
          unlockCardUI(card, false);
        } else {
          lockCardUI(card);
        }
      }
    });
  }

  function hideLock(card) {
    const overlay = card.querySelector('.lock-overlay');
    if (overlay) overlay.style.display = 'none';
    card.querySelector('.card-click').disabled = false;
    card.setAttribute('aria-hidden', 'false');
  }
  function showLock(card) {
    const overlay = card.querySelector('.lock-overlay');
    if (overlay) overlay.style.display = '';
    card.querySelector('.card-click').disabled = true;
    card.setAttribute('aria-hidden', 'true');
  }

  function lockCardUI(card) {
    card.classList.add('locked');
    showLock(card);
  }

  function unlockCardUI(card, persist=true) {
    card.classList.remove('locked');
    hideLock(card);
    // remove lock overlay attribute for screen readers
    const overlay = card.querySelector('.lock-overlay');
    if (overlay) overlay.setAttribute('aria-hidden','true');

    if (persist) {
      const st = readState();
      st['unlocked_' + card.dataset.index] = true;
      writeState(st);
    }
  }

  // flipping behavior (only when unlocked)
  document.querySelectorAll('.card').forEach(card => {
    const btn = card.querySelector('.card-click');
    btn.addEventListener('click', (e)=> {
      if (card.classList.contains('locked')) {
        // optionally show a small shake or animation; for now just no-op
        btn.blur();
        return;
      }
      // toggle flip
      const flipped = card.classList.toggle('flipped');
      btn.setAttribute('aria-pressed', flipped ? 'true' : 'false');
      // reveal/hide backface for accessibility
      const back = card.querySelector('.card-back');
      if (back) back.setAttribute('aria-hidden', flipped ? 'false' : 'true');
    });
    // also allow Enter/Space to flip via keyboard (button semantics handle it)
  });

  // compute played sum from video.played TimeRanges
  function playedSum(v) {
    try {
      const tr = v.played;
      let s = 0;
      for (let i=0;i<tr.length;i++){
        s += tr.end(i) - tr.start(i);
      }
      return s;
    } catch(e){ return 0; }
  }

  // update progress UI
  function updateProgress() {
    const duration = video.duration || 0;
    if (!duration || !isFinite(duration)) {
      progBar.style.width = '0%';
      watchedPct.textContent = '0%';
      return;
    }
    const sum = playedSum(video);
    const ratio = Math.min(1, sum / duration);
    progBar.style.width = (ratio*100).toFixed(2) + '%';
    watchedPct.textContent = Math.round(ratio*100) + '%';
    if (ratio >= WATCH_THRESHOLD) {
      // mark complete
      videoState.textContent = 'Complete';
      videoState.style.color = '#059669';
      unlockNextCourse(0); // unlock card at index 1 (0 -> 1)
    } else {
      videoState.textContent = 'Not complete';
      videoState.style.color = '#64748b';
    }
  }

  // Unlock next card after index idx (persistent)
  function unlockNextCourse(idx) {
    const nextIndex = idx + 1;
    const nextCard = document.querySelector(`.card[data-index="${nextIndex}"]`);
    if (!nextCard) return; // nothing to unlock
    if (!nextCard.classList.contains('locked')) return; // already unlocked
    // Unlock with UI effect
    unlockCardUI(nextCard, true);
    // Announce to screen readers
    nextCard.setAttribute('aria-live', 'polite');
    setTimeout(()=> nextCard.removeAttribute('aria-live'), 2000);
  }

  // Wire video events
  if (video) {
    // allow mobile autoplay behavior if needed: user must interact for play
    video.addEventListener('timeupdate', updateProgress);
    video.addEventListener('seeked', updateProgress);
    video.addEventListener('ended', () => {
      // ended may happen even if user skipped; timeupdate already handled ranges
      updateProgress();
    });

    // In case metadata loads after script
    video.addEventListener('loadedmetadata', updateProgress);

    // also a safety: periodically check played ranges (for browsers with odd events)
    const intervalCheck = setInterval(()=> {
      if (document.visibilityState === 'hidden') return;
      if (!video.duration || !isFinite(video.duration)) return;
      updateProgress();
    }, 1200);

    // clean up on unload (not strictly necessary)
    window.addEventListener('beforeunload', ()=> clearInterval(intervalCheck));
  }

  // init from saved state
  initFromState();

  // Expose a small API in case you want to unlock programmatically:
  window.courseLocks = {
    unlock(index){
      const card = document.querySelector(`.card[data-index="${index}"]`);
      if (card) unlockCardUI(card, true);
    },
    lock(index){
      const card = document.querySelector(`.card[data-index="${index}"]`);
      if (card) lockCardUI(card);
      const st = readState();
      delete st['unlocked_' + index];
      writeState(st);
    },
    reset(){
      localStorage.removeItem(STORAGE_KEY);
      initFromState();
      // reload to clear flips
      setTimeout(()=>location.reload(), 100);
    },
  };
})();
</script>
</body>
</html>
