<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>individual-course</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <link rel="stylesheet" href="css-files/individual-course.css">
</head>
<body>
  <nav class="navbar bg-light navbar-expand-lg fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Course 7</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNavbar" aria-controls="offcanvasNavbar">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNavbar" aria-labelledby="offcanvasNavbarLabel">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title" id="offcanvasNavbarLabel">Navigation</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body">
        <ul class="navbar-nav justify-content-center flex-grow-1 pe-3">
          <li class="nav-item">
            <a class="nav-link active mx-lg-2" aria-current="page" href="#">Home</a>
          </li>
         
            <li class="nav-item">
            <a class="nav-link mx-lg-2" href="welcoming-page.htm">Go Back</a>
          </li>
        </ul>
        
      </div>
    </div>
  </div>
</nav>
<main>
     <!-- LEFT -->
     <div class="left-side">
       <div id="player"></div>
        <h1>Description :</h1>
        <p class="course-description">
         ALLAH cares about us humans , and made cure in the quoran for mental breakdowns , explore more throughout this section</p>
            <button
          class="next-btn1"
          onclick=" 
               
              checkMoving(); 
               
               "
        >
          Move to Next
        </button>
     </div>
        
  
      <!-- RIGHT: Subtitle Tracker -->
  <div class="tracker" id="tracker"></div>
   
  
   
    
</main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
let player;
let subtitlesDivs;
let subtitles = []; //the parts will be tracked in an array
const trackerDiv = document.getElementById("tracker");
let watchedTime = parseFloat(localStorage.getItem("watchedTime")) || 0;
let lastTime = watchedTime;
let trackingInterval = null;

const required_percent = 80; //the percentage required to unlock the next course
const courseId = parseInt(document.body.dataset.courseId);

// Load YouTube IFrame API
const tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
document.body.appendChild(tag);

// called automatically when API is ready
function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
        height: '390',
        width: '640',
        videoId: 'CQ6C4NXJaUc', //the video id
        playerVars: { playsinline: 1, controls: 1, rel: 0 },
        events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
        },
    });
}

// called when video is ready
function onPlayerReady() {
    player.seekTo(0, true);
    const totalDuration = player.getDuration();
    const partDuration = totalDuration / 5;

    for (let i = 0; i < 5; i++) {
        subtitles.push({
            text: `Part ${i + 1}`,
            start: i * partDuration,
            end: (i + 1) * partDuration,
        });
    }

    // display tracker
    trackerDiv.innerHTML = "";
    subtitles.forEach((s) => {
        const div = document.createElement("div");
        div.classList.add("subtitle");
        div.textContent = s.text;
        trackerDiv.appendChild(div);
    });
    subtitlesDivs = document.querySelectorAll('.subtitle');

    // restore watched time if available
    if (watchedTime > 0 && watchedTime < totalDuration) {
        player.seekTo(watchedTime, true);
    }
}

let isSeeking = false; // <--- new guard flag

function onPlayerStateChange(event) {
    if (event.data == YT.PlayerState.PLAYING) {
        trackingInterval = setInterval(() => {
            let t = player.getCurrentTime();

            // Prevent skipping ahead
            if (!isSeeking && t > lastTime + 0.5) { // allow tiny drift
                isSeeking = true; // block further alerts
                alert("Skipping ahead is not allowed!");
                player.seekTo(lastTime, true);

                // small timeout to release the flag after the seek completes
                setTimeout(() => {
                    isSeeking = false;
                }, 200);
                return; // exit this iteration
            }

            if (t > lastTime) watchedTime += (t - lastTime);
            lastTime = t;

            highlightSubtitle(t);
            checkUnlock();
        }, 500);
    } else if (event.data == YT.PlayerState.PAUSED || event.data == YT.PlayerState.ENDED) {
        clearInterval(trackingInterval);
        localStorage.setItem("watchedTime", watchedTime);
    }
}
// highlight tracker
function highlightSubtitle(time) {
    subtitles.forEach((s, i) => {
        if (time >= s.start && time < s.end) {
            subtitlesDivs[i].classList.add('active');
        } else {
            subtitlesDivs[i].classList.remove('active');
        }
    });
}

// check unlock
function checkUnlock() {
    const total = player.getDuration();
    const percentage = (watchedTime / total) * 100;
    if (percentage >= required_percent) {
        console.log("You can now move to next course");
    }
}

// next button
function checkMoving() {
    const total = player.getDuration();
    const percentage = (watchedTime / total) * 100;
    if (percentage >= required_percent) {
        window.location.href = "course 8.htm";
    } else {
        alert("You need to watch at least 80% of this course before moving to the next!");
    }
}

    </script>
</body>
</html>